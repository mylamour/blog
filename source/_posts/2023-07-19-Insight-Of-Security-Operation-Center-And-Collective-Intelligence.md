---
layout: post
title: 安全运营中心（SOC）与集体智慧
categories: 安全架构师
kerywords: 安全运营 安全运营中心 SOC 安全架构 企业安全 安全设计
tags: 安全架构
---


> 写于七月十九日，发布于七月二十五日

# 1. 运营与SOC
关于安全运营其实已经有很多的文章去写了，很多企业在多年前就或早或晚的进入了运营时代。得益于我自己经历过几次0-1的安全建设，本文且从团队和架构的角度回过头再看一看SOC的相关设计。 经验有限，请运营的大佬们轻拍。

## 1.1 团队与协作
基本上安全团队在搭建完基础设施之后，就开始进入到运营阶段，随后运营团队规模逐渐扩大，安全负责人很快被各种个样的看板淹没。我们先看一下SOC团队的大概样子，从响应流程上来说通常会有tier 1到tier 3。从职责上来看，大型的SOC team会负责监控运营，红蓝对抗，威胁智能，取证应急这几大块。
![img](https://img.iami.xyz/images/soc-team-org.png)

从能力成熟度模型上[CMM-SOC](https://www.secrss.com/articles/32893)来说，一个可正常运营的SOC至少需要具备Level 2的相关特性。往往大厂的SOC已经在Level 3了（起码宣传上至少已经在Level 3 之上了，记得之前阿里某安全专家已经开始提出了数智化安全运营的概念。），并且具备7*24的oncall能力，也能和NOC联动处置一些问题

至于协作流程，此处依旧采用上篇博客[数据安全架构总结及案例分享](https://iami.xyz/data-security-and-archtecture-selected/) 里的，此处不再介绍，感兴趣的话可以阅读一下。 ![img](https://img.iami.xyz/images/data+driven+soc+arch.png) 

另外大家可以带着疑问去阅读后面的内容。比如你买了很多产品、软件、设备，有没有真正的用起来？什么时候需要成立/拆分出SOC团队了？你定了很多运营指标，是不是真的能够反映运营质量？工程师写了几十上百条规则，有哪些被触发了？

## 1.2 数据计算平台与特征工程
虽然我并不清楚某些产品的Capability是怎么样的，但对于数据的流向和流程还是比较清楚的。一般是对Data Sources进行Batch Ingestion并将其存储到Data Lake，现在云上的Blob Storage，都已经能够承担数据湖的角色，以AWS为例，可以用Redshift也可以用S3。之后对数据进行清洗，一般是在一个Pipeline内完成清洗，标准化以及验证。这里需要指出的是在标准化的过程中需要数据字典，能够将不同的字段统一mapping成预设字段。

![img](https://img.iami.xyz/images/data-computing-and-machine-learing-cloud-solutions-and-open-source-solutions.png)

之后就可以写规则了，规则除了作用在各自单独的系统之外，最多的产出地就是在数据计算平台，后面也会讲一下衡量运营的指标。Spark配Groovy去写是OK的，Splunk自带的SPL也是OK的。当然这些大多是基于条件规则，如果说要采用一些机器学习的方法就需要另一个关键的过程——特征工程（话说实际除了商业产品自带的机器学习之外，我并没有在大厂之外看到能用机器学习/深度学习做入侵检测的）。特征工程简单的可以理解为一个多项式函数的系数集合。挖掘特征可以通过专家经验，也可以让神经网络自动去寻找。我已经有一段时间没关注过这一块了，翻了翻之前的[特征工程笔记](https://iami.xyz/meituanmachinelearning-featureenginne-note/)还是2018年的。最后通过对模型训练及验证(tarin & evaluate)后进行部署并对外提供API接口。一方面可以通过API消费模型，一方面可以完成可视化，以及完成自动化等。在数据计算平台这里还可以引入很多外部数据，例如购买的Threat Intelligence，目前Splunk Enterprise Security就支持类似的功能。注意TI是按查询次数收费的，可以适当的缓存名单数据24h内的重复查询。并提供给其他系统使用。（BTW：Virustotal的工程师嘲讽某步是盗用他们的数据）。

注：我对以Hadoop为底层实现数仓没有实际的架构经验，工作中也仅使用过ODPS、SLS和Splunk、Groovy、Spark。云上的方案只做过AWS和Azure的POC，并不清楚具体在生产环境的容量和性能表现。（理论上来说，云上只需要加大充值就可以实现具体的性能，架构本身不受影响）

## 1.3 运营目标与质量 
假设我们以数据驱动（data-driven）安全运营为原则，把自动化，标准化，场景化，可视化作为目标。（往往缺什么，越喜欢强调什么😓）

1. 过程
我们用IPDRR模型来表示过程，并把安全运营可能涉及到的内容mapping进去。如图所示，安全运营在识别过程主要会做资产管理和风险评估（这个评估标准需要由治理或架构团队提供）。在防御过程会涉及到安全控制的实施，规则的开发等等，类似的在后续过程进行实时的监控告警，事件管理，灾难恢复等。
![img](https://img.iami.xyz/images/ipdrr-soc-mapping-scenario.png)
另外我们换个视角，如果以Detect视角看IPDRR。去做Identify其实就是做Threat Modeling，做Protect就要去做一些Rule Tuning的工作（设备和服务提供的职责由安全运维或安全平台组提供），以及等等。
//图中内容不必完全当真，每个企业内应用的方式也不相同。
2. 指标
如何衡量运营的质量，需要有质量评估。在以上的过程，除了MTTA，MTTD，MTTR，还需要通过关注以下实体的指标去衡量SOC运营的质量。 ![img](https://img.iami.xyz/images/soc-workflow-entity.png)
可以看到这里有告警、事件、SOP、规则、Playbook等实体，这里我们关注除System以外的实体（System有另外的指标，这里仅关注SOC运营时的指标）。**例如：Volume（总量、新增量）、Accuracy（T-P、 F-P、T-N、 F-N）、 Priority(P0事件 - PN事件)、 Cost（时间/开发时间，溯源时间等、人力）**。
在这个过程可以考虑每个实体的准确率，告警里有多少正确的，Playbook有没有正确执行等等，各个的总量以及新增数量（一旦这些数据接入了数据平台，只需要洗出相应报表即可，具备日，周，月，季度视图。**在汇报时，领导并不关注细节，甚至除了运营团队自身之外，其他团队都更关注质量而非过程**）。除此之外，还需要关注伴生指标以及对立指标。例如**考虑覆盖率的同时，需要考虑健康度**作为伴生指标。否则你可能100%覆盖率，80%健康度（另外的20%可能由于CPU，MEM反复重启，或者无法正常执行进程等等），类似的培训完成率以及钓鱼中招率。 对立指标有T-P以及F-P，即要看**正确触发警报的实际问题的比例，也要看没有实际问题时触发的警报的比例**。 除此之外你一定还听过很多框架，例如在内部探讨SOC架构设计的时候。也曾听到过一些声音，说框架很多不便选择，比如SOC已经采用了ATT&CK框架。其实这里并不冲突。SOC采用ATT&CK衡量在数据平台覆盖检测场景，ATT&CK恰恰是作为场景化目标的一个参考框架。但这里就引出了一个新的问题，就是你参考ATT&CK覆盖了20个场景，上线了70条规则，真的有效吗？怎么衡量？在计算平台上触发检测还是把规则同步到每个System上执行？与此类似的还有采购了威胁情报。我们知道威胁情报可以提供domain, ip, url, cert, JA3, email, hash等IOC，那这些IOC也可以被应用到其他不同的系统中去，比如说SIEM、ASM、WAF等，除此之外还有新的一些衡量指标。比如场景被触发的数量，**由威胁情报产生的告警数（命中率），这部分告警的准确率，覆盖在哪些场景上**。
最后还需要一些统计学维度的指标，例如：Top10的告警来自哪些规则，分别触发的Playbook（以及执行了多少次），命中在KillChain的哪些阶段，命中了ATT&CK中的哪些场景，事件分别是什么类别，以及新增类型的事件哪些被转换成了SOP。以此来衡量SOC团队的运营质量。

这里就不得不提一下响应时间了，使用微微一软家的产品在管理端下发一次配置，技术支持的标准回答是生效时间在6h-24h以上。但有时候是6h以内，有时候是24h以上。当你做了SOD之后，激活一次权限之后，甚至需要登入登出才能刷新看到对应的管理界面。

# 2. 集体智慧（Collective Intelligence）
以下内容可跳过。
最早了解到集体智慧这个词是来源于《集体智慧编程》这本书。但集体智慧这个词真的是让我感觉既陌生又熟悉。虽然听到过不少次，但实际又很少在现实中见到过。总结起来似乎是**一方面由于个体水平不同导致不同程度的傲慢和偏见，另一方面团体协作也带来了一定程度的混乱**。我相信每个企业都有一些“生不逢时”的工程师，一边认为自己是千里马，期待同伯乐来个相见恨晚，一边又懊悔公司没人能够慧眼识珠。但实际集体智慧又是不能脱离集体存在的，在集体中产生的活动，无论承认与否，或多或少都依赖了集体环境。很多时候员工认为个体智慧有很大的功劳，带来了很多收益，实际上却忽虑了平台的作用。那些工作未逢伯乐的同事，他们长期以来，逐渐建立了一层针对工作的情绪滤网，长期以来的负反馈（不加薪，不升职，不给项目，被challenge）让他们愈发抵触来自对立面的输入，也丧失了推广自己方案的主动性。即便可能在某个方向是专业的（甚至不一定需要是专业的）。这对于SOC团队是不利的，因为提升个体智慧不一定能增益集体智慧，但是个体智慧下降却会损益集体智慧。

我没办法很好的去讲对集体智慧的理解，但仅从四个方面去看，产生集体智慧的关键有**信息共享、集体决策、沟通、创新**。主要**体现为协作（信息共享和沟通也是团队协作的关键）与决策**。那么如何进行集体决策和创新呢（好像在甲方安全工作中，创新不是那么重要）？这里就不得不提到另一个概念——可理解输入。因为集体智慧需要每个个体参与，**而你的创新和决策只能基于你的可理解程度**。可理解输入是能够帮助个体主动学习一种方式。**可理解输入指的是只获取i+1（恰好比你理解的多一点）的知识，它有三个条件：有趣、足量、可理解。当趣味度大于压力水平的时候，更多的知识可以通过个人的情绪滤网（affective filter），能够被有效的吸收**。这个理论是我最近在英语学习过程中了解到的，来自Dr. Stephen。

在SOC运营中，毫无疑问需要依赖大量的协作。对内需要在tier 1、tier 2、 tier 3同事之间，对外需要在风控、合规、数据等部门进行配合。从事件应急，事故复盘，汇报，写文档，培训等日常工作中可窥一斑。几乎处处涉及到集体决策。然而这又让我想到个体决策与集体决策的平衡点。我们大可以使用专家经验进行决断，也可以使用集体智慧。很多时候面临来自领导的决策，是不是能够用集体智慧去弥补个体智慧的不足？作为Leader/Manager，如何把任务或者意图有效的表达给员工使其理解并接受是非常有必要的。当然也有一些人的风格是，我说了，不管你接不接受去执行就可以了，这里不予置评。我们再次回到可理解输入的概念上，前面是你需要获得可理解输入提升自己，这次你需要向领导提供可理解输入。比如当你的manager给你提出了个一个方案需要你去实施的时候，你虽然有一个更优的解决方案，但你一上来就否定了manager的方案，或者告诉他不能做。如果对方没有经受过训练，此时情绪滤网一定是对你收缩，当你再次提出新方案的时候，就难免遇到一些阻碍。如果其中涉及到的一些知识是其尚未接触过的，对于方案的推广来说将更加困难。即便他可能知道你的方案是更优的，也没办法很快的从内心接受了。所以一定要注意向其提供可理解输入。另外还可以通过安全治理委员会来规避一些不合理的需求和决策，使集体智慧大于个人智慧。

# 3. 总结

其实企业对安全运营工程师的招聘要求一直以来时是比较宽松的。因为大部分情况只需要先能够快速上手重复的任务即可。但作为架构师，我跟踪了几个月SOC团队的工作状况后略有收获，也针对SOC团队做了一些设计。但是实际效果一般，我自己将其归结为未能很好帮助SOC团队输出他们的集体智慧（即便大部分时候集体并没有什么智慧可言）。同样的，在几个月之前，我也认为架构团队的输出有限。当时认为是因为信息差和参与度不够，但即便后来成立了安全治理委员会也未能完全解决这个问题。现在我将其也归结于集体智慧工程的失败。因为参与只能解决信息差的问题，还需要通过“创新”与沟通进行输出，但由于执行过程往往不在架构组，所以仍需进行一定的验证。由此闭环，完成团队协作及输出。

另外大厂搞自研不必瞧不起小厂，小厂也不必觉得大厂就多厉害；买商业产品的也不要觉得比开源厉害多少，用开源的也不用羡慕有预算采购的的；互联网大可不必吹嘘所谓技术，银行也不用接受互联网行业的忽悠。没有最好的，只有最适合的。有优势必有劣势，场景化定制度很高，那就不易于通用。买了E5，也不代表着能有定制化，不少东西依旧需要单独付费。

LLM使得集体智慧的结果更容易被每个人获取到，GPT对合约进行审计能够大幅提升效率。

<!-- Work-Life Balance VS Work-Life Health? -->

参考内容：
* [Do you still need a manual smart contract audit?](https://arxiv.org/pdf/2306.12338.pdf)
* [MLOps foundation roadmap for enterprises with Amazon SageMaker](https://aws.amazon.com/blogs/machine-learning/mlops-foundation-roadmap-for-enterprises-with-amazon-sagemaker/?mld_ops10)
* [维基百科-集体智慧](https://zh.wikipedia.org/zh-hans/%E9%9B%86%E9%AB%94%E6%99%BA%E6%85%A7)
* [安全运营中心能力成熟度模型 (CMM-SOC) 构建](https://www.secrss.com/articles/32893)